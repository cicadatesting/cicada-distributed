version: "3"
services:
  db:
    image: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=admin
    ports:
      - 3306:3306
  flyway:
    image: flyway/flyway:6-alpine
    command: -url=jdbc:mysql://db:3306/ -schemas=mydb -user=root -password=admin -connectRetries=60 migrate
    volumes:
      - .:/flyway/sql
    depends_on:
      - db
  api:
    build: .
    ports:
      - 8080:8080
    depends_on:
      - db
      - flyway
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - /home/jeremy/Documents/projects/cicada-distributed/demos/rest-api/app/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - 9090:9090
  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - 3000:3000
    environment:
      # - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_NAME=dashboard
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      # - /home/jeremy/Documents/projects/cicada-distributed/grafana.ini:/etc/grafana/grafana.ini
      - /home/jeremy/Documents/projects/cicada-distributed/demos/rest-api/app/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml
